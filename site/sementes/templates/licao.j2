{% extends "base.j2" %}
{% from "macros.j2" import scene_card, instruction_box, script_persona, nav_button, portador_block, local_card, author_box %}

{# SSOT: Configura√ß√£o centralizada de guardi√µes #}
{% from '_config.j2' import get_avatar %}
{% set avatar_file = get_avatar(licao.metadados.guardiao_lider) %}

{% block content %}

{# 1. HEADER DA LI√á√ÉO COM NAVEGA√á√ÉO #}
{# L√≥gica Hybrida: Prioriza link calculado (auto), fallback para manual (yaml) #}
{% set nav_prev = licao.navegacao_calculada_prev if licao.navegacao_calculada_prev else licao.navegacao.anterior %}
{% set nav_next = licao.navegacao_calculada_next if licao.navegacao_calculada_next else licao.navegacao.proxima %}

<div class="lesson-header-nav" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #E5E7EB;">
    <div style="width: 33%;">
        {% if nav_prev %}
        <a href="{{ nav_prev.url if nav_prev.url else '#' }}" class="nav-mini-link" style="text-decoration: none; color: #6B7280; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
            <span>‚Üê</span> <span>{{ nav_prev.titulo }}</span>
        </a>
        {% endif %}
    </div>
    
    <div style="width: 33%; text-align: center;">
        <img src="../assets/icon-sementes.png" alt="Sementes" style="height: 32px; opacity: 0.8;" onerror="this.style.display='none'">
    </div>
    
    <div style="width: 33%; text-align: right;">
        {% if nav_next %}
        <a href="{{ nav_next.url if nav_next.url else '#' }}" class="nav-mini-link" style="text-decoration: none; color: #6B7280; font-size: 0.9rem; display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem;">
            <span>{{ nav_next.titulo }}</span> <span>‚Üí</span>
        </a>
        {% endif %}
    </div>
</div>

{# 1. PREPARA√á√ÉO #}
{% call scene_card("Prepara√ß√£o do Portador", "üë®‚Äçüë©‚Äçüëß") %}
    {# SUBT√çTULO: OBJETIVO PEDAG√ìGICO #}
    {% if licao.metadados.objetivo_pedagogico %}
    <div style="text-align: center; margin-bottom: 1.5rem; color: #6B7280; font-size: 0.9rem; font-style: italic;">
        {{ licao.metadados.objetivo_pedagogico }}
    </div>
    {% endif %}

    {% call instruction_box("üí°") %}
        <strong>Dica do Cora√ß√£o:</strong> {{ licao.para_portador.dica_coracao | replace('\n', '<br>') | safe }}
    {% endcall %}

    {# P1: MATERIAIS COM SEPARA√á√ÉO ESSENCIAL/OPCIONAL #}
    {% if licao.para_portador.preparacao and licao.para_portador.preparacao.materiais %}
    {% set essenciais = licao.para_portador.preparacao.materiais | selectattr('essencial', 'true') | list %}
    {% set opcionais = licao.para_portador.preparacao.materiais | rejectattr('essencial', 'true') | list %}
    
    <div class="materials-box" style="background:#F0FDF4; border:1px solid #BBF7D0; border-radius:8px; padding:1.25rem; margin:1.5rem 0;">
        {% if essenciais %}
        <p><strong>üéØ Essencial:</strong></p>
        <ul style="margin-top:0.5rem; margin-left:1rem;">
            {% for mat in essenciais %}
            <li>{{ mat.item }}{% if mat.qtd %} ({{ mat.qtd }}){% endif %}</li>
            {% endfor %}
        </ul>
        {% endif %}
        
        {% if opcionais %}
        <p style="margin-top:1rem;"><strong>üì¶ Se tiver:</strong></p>
        <ul style="margin-top:0.5rem; margin-left:1rem; color:#6B7280;">
            {% for mat in opcionais %}
            <li>{{ mat.item }}{% if mat.qtd %} ({{ mat.qtd }}){% endif %}</li>
            {% endfor %}
        </ul>
        {% endif %}
        
        {# Fallback: se nenhum material tem 'essencial' definido, mostra tudo #}
        {% if not essenciais and not opcionais %}
        <p><strong>üéí Materiais:</strong></p>
        <ul style="margin-top:0.5rem; margin-left:1rem;">
            {% for mat in licao.para_portador.preparacao.materiais %}
            <li>{{ mat.item }}{% if mat.qtd %} ({{ mat.qtd }}){% endif %}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endif %}

    {# P2: FILHO DESCOBRE #}
    {% if licao.para_portador.filho_descobre %}
    <p><strong>üåü Seu filho vai descobrir:</strong> {{ licao.para_portador.filho_descobre }}</p>
    {% endif %}

    <p><strong>üõ°Ô∏è Protocolo de Impecabilidade:</strong> {{ licao.para_portador.protocolo_impecabilidade | replace('\n', '<br>') | safe }}</p>
    <p><strong>üïäÔ∏è Nota de Gra√ßa:</strong> {{ licao.para_portador.nota_graca | replace('\n', '<br>') | safe }}</p>
{% endcall %}


{# 2. RITUAL DE ABERTURA #}
{% call scene_card("Ritual de Abertura", "üé¨") %}
    {% call instruction_box("üïØÔ∏è") %}
        {{ licao.ritual_abertura.instrucao_ambiente }}
    {% endcall %}

    <p><strong>üå´Ô∏è Transi√ß√£o:</strong> {{ licao.ritual_abertura.transicao_reino | replace('\n', '<br>') | safe }}</p>

    {# P1: ABERTURA SENSORIAL #}
    {% if licao.ritual_abertura.abertura_sensorial %}
    <div class="sensory-box" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius:8px; padding:1.25rem; margin:1.5rem 0; font-style:italic; color:#92400E; border-left:4px solid #F59E0B;">
        {{ licao.ritual_abertura.abertura_sensorial | replace('\n', '<br>') | safe }}
    </div>
    {% endif %}

    {{ portador_block(
        tom=licao.ritual_abertura.fala_portador.tom,
        texto=licao.ritual_abertura.fala_portador.script
    ) }}

    <div style="text-align:center; margin-top:2rem;">
        <p style="font-size:0.9rem; color:#9CA3AF; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:1px;">Visualizar</p>
        <img src="../assets/cards/guardioes/{{ avatar_file }}" 
             style="width:120px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.1); transform: rotate(-2deg); border: 4px solid white;"
             onError="this.src='../assets/cards/guardioes/placeholder.png'"
             alt="Card {{ licao.metadados.guardiao_lider }}">
    </div>
{% endcall %}


{# 3. JORNADA #}
<h2>üó∫Ô∏è A Jornada</h2>

{% for cena in licao.jornada.narrativa_principal %}
    {% call scene_card(cena.titulo, "‚ú®") %}
        {% if loop.first and cena.local %}
        {{ local_card(
            nome=cena.local | replace('_', ' ') | title,
            imagem='local-' ~ cena.local | replace('_', '-') ~ '.png'
        ) }}
        {% endif %}

        {# CARD DO GUARDI√ÉO APARECE ANTES DA FALA #}
        {% if cena.card_guardiao %}
        <div style="text-align:center; margin:1.5rem 0;">
            <p style="font-size:0.85rem; color:#9CA3AF; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:1px;">Mostrar Card</p>
            <img src="../assets/cards/guardioes/{{ cena.card_guardiao }}" 
                 style="width:140px; border-radius:12px; box-shadow:0 6px 12px rgba(0,0,0,0.15); transform: rotate(-2deg); border: 4px solid white;"
                 onError="this.src='../assets/cards/guardioes/placeholder.png'"
                 alt="Card {{ cena.card_guardiao | replace('.png', '') | replace('-', ' ') | title }}">
        </div>
        {% endif %}

        {% if cena.instrucao_portador %}
            {% call instruction_box("üëâ") %}
                {{ cena.instrucao_portador | replace('\n', '<br>') | safe }}
            {% endcall %}
        {% endif %}

        {{ script_persona(
            name=licao.metadados.guardiao_lider,
            avatar=avatar_file,
            text=cena.fala_guardiao.script,
            tone=cena.fala_guardiao.tom
        ) }}
    {% endcall %}
{% endfor %}


{# 4. CONCRETO #}
<h2>üß± O Concreto</h2>
{% call scene_card("Atividade Concreta", "üß±") %}
    {% if licao.jornada.concreto.fala_motivadora %}
    {{ script_persona(
        name=licao.metadados.guardiao_lider,
        avatar=avatar_file,
        text=licao.jornada.concreto.fala_motivadora
    ) }}
    {% endif %}

    {% call instruction_box("üìã") %}
        <strong>Passo a Passo:</strong>
        <ol style="margin-top:0.5rem; margin-left:1rem;">
            {% for passo in licao.jornada.concreto.instrucoes_portador %}
            <li>
                {{ passo.acao }}
                {% if passo.fala_sugerida %}
                <br><em>Fala sugerida: "{{ passo.fala_sugerida }}"</em>
                {% endif %}
            </li>
            {% endfor %}
        </ol>
    {% endcall %}

    {# Norte Absoluto removido - explicado no Manual dos Pais #}
{% endcall %}


{# 5. NARRA√á√ÉO #}
{% call scene_card("Narramos Juntos", "üó£Ô∏è") %}
    {% call instruction_box("ü§´") %}
        {{ licao.narracao.instrucao_portador | replace('\n', '<br>') | safe }}
    {% endcall %}

    {{ script_persona(
        name=licao.metadados.guardiao_lider,
        avatar=avatar_file,
        text='"O que voc√™ descobriu hoje na Clareira? O que contaria para o Melquior?"'
    ) }}

    <p><strong>Perguntas do Cora√ß√£o:</strong></p>
    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
        <li>{{ licao.narracao.pergunta_principal }}</li>
        {% for perg in licao.narracao.perguntas_coracao %}
        <li>{{ perg }}</li>
        {% endfor %}
    </ul>
{% endcall %}


{# 6. FECHAMENTO #}
{% call scene_card("Ritual de Fechamento", "üèÅ") %}
    {{ script_persona(
        name=licao.metadados.guardiao_lider,
        avatar=avatar_file,
        text=licao.ritual_fechamento.fala_guardiao.script,
        tone=licao.ritual_fechamento.fala_guardiao.tom
    ) }}

    {# Fio de Ouro removido - coberto pelo Linkage #}

    {{ portador_block(
        tom=none,
        texto=licao.ritual_fechamento.transicao_volta.fala
    ) }}
{% endcall %}


{# P1: LINKAGE - CONEX√ÉO ENTRE LI√á√ïES #}
{% if licao.linkage %}
{% call scene_card("Conex√£o da Jornada", "üîó") %}
    {% if licao.linkage.elo_anterior %}
    <p><strong>‚¨ÖÔ∏è √öltima Aventura:</strong> {{ licao.linkage.elo_anterior.gancho }}</p>
    {% endif %}
    {% if licao.linkage.proximo %}
        <div onclick="window.location.href='{{ nav_next.url if nav_next else '#' }}'" style="cursor: pointer;">
            <p><strong>‚û°Ô∏è Pr√≥xima Aventura:</strong> {{ licao.linkage.proximo.gancho }}</p>
            {% if nav_next %}
            <div style="margin-top:0.5rem; text-align:right;">
                <span style="font-size:0.85rem; color:#4B5563; background:#F3F4F6; padding:0.25rem 0.75rem; border-radius:1rem;">
                    Ir para {{ nav_next.titulo }} ‚Üí
                </span>
            </div>
            {% endif %}
        </div>
    {% endif %}
{% endcall %}
{% endif %}


{# P1: PARA FAM√çLIA - EXPLICA√á√ÉO PEDAG√ìGICA #}
{% if licao.para_familia %}
{% call scene_card("Para a Fam√≠lia", "üë®‚Äçüë©‚Äçüëß‚Äçüë¶") %}
    <p><strong>üìö Por que isso importa:</strong></p>
    <div style="padding:0.5rem 0;">
        {{ licao.para_familia.porque_importa | replace('\n', '<br>') | safe }}
    </div>
    
    {# M√âTODO CPA - BRUNER (azul) #}
    {% if licao.para_familia.metodo_cpa %}
    <div class="bruner-box">
        <strong>üß† M√©todo CPA (Jerome Bruner):</strong><br>
        <ul style="margin:0.5rem 0 0 1.5rem;">
            <li><strong>Concreto:</strong> {{ licao.para_familia.metodo_cpa.concreto }}</li>
            <li><strong>Pict√≥rico:</strong> {{ licao.para_familia.metodo_cpa.pictorico }}</li>
            <li><strong>Abstrato:</strong> {{ licao.para_familia.metodo_cpa.abstrato }}</li>
        </ul>
        {% if licao.para_familia.metodo_cpa.nota %}
        <span style="color:#6B7280; font-size:0.9rem;">{{ licao.para_familia.metodo_cpa.nota }}</span>
        {% endif %}
    </div>
    {% endif %}
    
    {# PRINC√çPIO CM (roxo) #}
    {% if licao.para_familia.principio_cm %}
    <div class="cm-box">
        <strong>üèõÔ∏è Princ√≠pio Charlotte Mason:</strong><br>
        <em>"{{ licao.para_familia.principio_cm.citacao }}"</em><br>
        <span style="color:#6B7280;">{{ licao.para_familia.principio_cm.aplicacao }}</span>
    </div>
    {% endif %}
    
    {# TGTB CONEX√ÉO (amarelo) #}
    {% if licao.para_familia.tgtb_conexao %}
    <div class="tgtb-box">
        <strong>üìò Conex√£o TGTB:</strong><br>
        <span style="color:#92400E;">{{ licao.para_familia.tgtb_conexao }}</span>
    </div>
    {% endif %}
    
    {# ESPIRAL - BRUNER (azul) #}
    {% if licao.para_familia.espiral %}
    <div class="bruner-box">
        <strong>üåÄ Curr√≠culo em Espiral (Bruner):</strong><br>
        <ul style="margin:0.5rem 0 0 1.5rem;">
            <li><strong>Agora:</strong> {{ licao.para_familia.espiral.conceito }} ‚Äî {{ licao.para_familia.espiral.volta_atual }}</li>
            <li><strong>Depois:</strong> {{ licao.para_familia.espiral.proxima_volta }}</li>
        </ul>
        {% if licao.para_familia.espiral.nota %}
        <span style="color:#6B7280; font-size:0.9rem;">{{ licao.para_familia.espiral.nota }}</span>
        {% endif %}
    </div>
    {% endif %}
    
    {# REFLEX√ÉO ESPIRITUAL (verde) #}
    {% if licao.para_familia.reflexao_espiritual %}
    <div class="espiritual-box">
        <strong>‚ú® Reflex√£o Espiritual:</strong><br>
        <span style="color:#166534;">{{ licao.para_familia.reflexao_espiritual }}</span>
    </div>
    {% endif %}
    
    {# NOTA DE GRA√áA (cinza) #}
    {% if licao.para_familia.nota_graca %}
    <div class="graca-box">
        <strong>üïäÔ∏è Nota de Gra√ßa:</strong><br>
        {{ licao.para_familia.nota_graca }}
    </div>
    {% endif %}
{% endcall %}
{% endif %}

{% endblock %}
