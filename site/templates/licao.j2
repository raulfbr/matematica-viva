{% extends "base.j2" %}
{% from "macros.j2" import scene_card, instruction_box, script_persona, nav_button %}

{# MAPEAMENTO GUARDIÃƒO -> ARQUIVO DE AVATAR #}
{% set guardian_avatars = {
    'celeste': 'celeste-raposa.png',
    'melquior': 'melquior-leao.png',
    'bernardo': 'bernardo-urso.png',
    'iris': 'iris-passarinho.png',
    'noe': 'noe-coruja.png'
} %}
{% set avatar_file = guardian_avatars.get(licao.metadados.guardiao_lider, 'placeholder.png') %}

{% block content %}

{# 1. PREPARAÃ‡ÃƒO #}
{% call scene_card("PreparaÃ§Ã£o do Portador", "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§") %}
    {% call instruction_box("ğŸ’¡") %}
        <strong>Dica do CoraÃ§Ã£o:</strong> {{ licao.para_portador.dica_coracao | replace('\n', '<br>') | safe }}
    {% endcall %}

    {# P1: MATERIAIS #}
    {% if licao.para_portador.preparacao and licao.para_portador.preparacao.materiais %}
    <div class="materials-box" style="background:#F0FDF4; border:1px solid #BBF7D0; border-radius:8px; padding:1.25rem; margin:1.5rem 0;">
        <strong>ğŸ’ Materiais NecessÃ¡rios:</strong>
        <ul style="margin-top:0.5rem; margin-left:1rem;">
            {% for mat in licao.para_portador.preparacao.materiais %}
            <li>{{ mat.item }} {% if mat.qtd %}({{ mat.qtd }}){% endif %}{% if mat.essencial %} â­{% endif %}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {# P2: FILHO DESCOBRE #}
    {% if licao.para_portador.filho_descobre %}
    <p><strong>ğŸŒŸ Seu filho vai descobrir:</strong> {{ licao.para_portador.filho_descobre }}</p>
    {% endif %}

    <p><strong>ğŸ›¡ï¸ Protocolo de Impecabilidade:</strong> {{ licao.para_portador.protocolo_impecabilidade | replace('\n', '<br>') | safe }}</p>
    <p><strong>ğŸ•Šï¸ Nota de GraÃ§a:</strong> {{ licao.para_portador.nota_graca | replace('\n', '<br>') | safe }}</p>
{% endcall %}


{# 2. RITUAL DE ABERTURA #}
{% call scene_card("Ritual de Abertura", "ğŸ¬") %}
    {% call instruction_box("ğŸ•¯ï¸") %}
        {{ licao.ritual_abertura.instrucao_ambiente }}
    {% endcall %}

    <p><strong>ğŸŒ«ï¸ TransiÃ§Ã£o:</strong> {{ licao.ritual_abertura.transicao_reino | replace('\n', '<br>') | safe }}</p>

    {# P1: ABERTURA SENSORIAL #}
    {% if licao.ritual_abertura.abertura_sensorial %}
    <div class="sensory-box" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius:8px; padding:1.25rem; margin:1.5rem 0; font-style:italic; color:#92400E; border-left:4px solid #F59E0B;">
        {{ licao.ritual_abertura.abertura_sensorial | replace('\n', '<br>') | safe }}
    </div>
    {% endif %}

    {{ script_persona(
        name="PORTADOR",
        avatar="melquior-leao.png",
        text=licao.ritual_abertura.fala_portador.script,
        tone=licao.ritual_abertura.fala_portador.tom,
        is_portador=True
    ) }}

    <div style="text-align:center; margin-top:2rem;">
        <p style="font-size:0.9rem; color:#9CA3AF; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:1px;">Visualizar</p>
        <img src="../assets/cards/guardioes/{{ avatar_file }}" 
             style="width:120px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.1); transform: rotate(-2deg); border: 4px solid white;"
             onError="this.src='../assets/cards/guardioes/placeholder.png'"
             alt="Card {{ licao.metadados.guardiao_lider }}">
    </div>
{% endcall %}


{# 3. JORNADA #}
<h2>ğŸ—ºï¸ A Jornada</h2>

{% for cena in licao.jornada.narrativa_principal %}
    {% call scene_card(cena.titulo, "âœ¨") %}
        {% if loop.first %}
        <p><strong>ğŸ“ Local:</strong> {{ cena.local | replace('_', ' ') | title }}</p>
        {% endif %}

        {% if cena.instrucao_portador %}
            {% call instruction_box("ğŸ‘‰") %}
                {{ cena.instrucao_portador | replace('\n', '<br>') | safe }}
            {% endcall %}
        {% endif %}

        {{ script_persona(
            name=licao.metadados.guardiao_lider,
            avatar=avatar_file,
            text=cena.fala_guardiao.script,
            tone=cena.fala_guardiao.tom
        ) }}
    {% endcall %}
{% endfor %}


{# 4. CONCRETO #}
<h2>ğŸ§± O Concreto</h2>
{% call scene_card("Atividade Concreta", "ğŸ§±") %}
    {% if licao.jornada.concreto.fala_motivadora %}
    {{ script_persona(
        name=licao.metadados.guardiao_lider,
        avatar=avatar_file,
        text=licao.jornada.concreto.fala_motivadora
    ) }}
    {% endif %}

    {% call instruction_box("ğŸ“‹") %}
        <strong>Passo a Passo:</strong>
        <ol style="margin-top:0.5rem; margin-left:1rem;">
            {% for passo in licao.jornada.concreto.instrucoes_portador %}
            <li>
                {{ passo.acao }}
                {% if passo.fala_sugerida %}
                <br><em>Fala sugerida: "{{ passo.fala_sugerida }}"</em>
                {% endif %}
            </li>
            {% endfor %}
        </ol>
    {% endcall %}

    <p><strong>ğŸ§­ Norte Absoluto (80%):</strong> {{ licao.jornada.concreto.norte_absoluto }}</p>
{% endcall %}


{# 5. NARRAÃ‡ÃƒO #}
{% call scene_card("Narramos Juntos", "ğŸ—£ï¸") %}
    {% call instruction_box("ğŸ¤«") %}
        {{ licao.narracao.instrucao_portador | replace('\n', '<br>') | safe }}
    {% endcall %}

    {{ script_persona(
        name=licao.metadados.guardiao_lider,
        avatar=avatar_file,
        text='"O que vocÃª descobriu hoje na Clareira? O que contaria para o Melquior?"'
    ) }}

    <p><strong>Perguntas do CoraÃ§Ã£o:</strong></p>
    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
        <li>{{ licao.narracao.pergunta_principal }}</li>
        {% for perg in licao.narracao.perguntas_coracao %}
        <li>{{ perg }}</li>
        {% endfor %}
    </ul>
{% endcall %}


{# 6. FECHAMENTO #}
{% call scene_card("Ritual de Fechamento", "ğŸ") %}
    {{ script_persona(
        name=licao.metadados.guardiao_lider,
        avatar=avatar_file,
        text=licao.ritual_fechamento.fala_guardiao.script,
        tone=licao.ritual_fechamento.fala_guardiao.tom
    ) }}

    <p><strong>ğŸ§µ Fio de Ouro:</strong> {{ licao.ritual_fechamento.fio_ouro }}</p>

    {{ script_persona(
        name="PORTADOR",
        avatar="melquior-leao.png",
        text=licao.ritual_fechamento.transicao_volta.fala,
        is_portador=True
    ) }}
{% endcall %}


{# P1: LINKAGE - CONEXÃƒO ENTRE LIÃ‡Ã•ES #}
{% if licao.linkage %}
{% call scene_card("ConexÃ£o da Jornada", "ğŸ”—") %}
    {% if licao.linkage.elo_anterior %}
    <p><strong>â¬…ï¸ Do que viemos:</strong> {{ licao.linkage.elo_anterior.gancho }}</p>
    {% endif %}
    {% if licao.linkage.proximo %}
    <p><strong>â¡ï¸ Para onde vamos:</strong> {{ licao.linkage.proximo.gancho }}</p>
    {% endif %}
{% endcall %}
{% endif %}


{# P1: PARA FAMÃLIA - EXPLICAÃ‡ÃƒO PEDAGÃ“GICA #}
{% if licao.para_familia %}
{% call scene_card("Para a FamÃ­lia", "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦") %}
    <p><strong>ğŸ“š Por que isso importa:</strong></p>
    <div style="padding:0.5rem 0;">
        {{ licao.para_familia.porque_importa | replace('\n', '<br>') | safe }}
    </div>
    
    {% if licao.para_familia.principio_cm %}
    <div class="cm-principle" style="background:#EDE9FE; border-left:4px solid #8B5CF6; padding:1rem; border-radius:0 8px 8px 0; margin-top:1rem;">
        <strong>ğŸ›ï¸ PrincÃ­pio CM #{{ licao.para_familia.principio_cm.numero }}:</strong><br>
        <em>"{{ licao.para_familia.principio_cm.citacao }}"</em><br>
        <span style="color:#6B7280;">{{ licao.para_familia.principio_cm.aplicacao }}</span>
    </div>
    {% endif %}
    
    {% if licao.para_familia.nota_graca %}
    <p style="margin-top:1rem;"><strong>ğŸ•Šï¸</strong> {{ licao.para_familia.nota_graca }}</p>
    {% endif %}
{% endcall %}
{% endif %}

{% endblock %}
